---
title: "Ecosystem-Based Juvenile Pacific Salmon (*Oncorhynchus* spp.) Survey off North East Vancouver Island, British Columbia, September 30 - October 8, 2019"
year: 2021
report_number: nnnn
author: |
  Erika D. Anderson,
  Jackie R. King, and
  Tyler B. Zubkowski
author_list: "Anderson, E.D., King, J.R. and Zubkowski, T.B."
region: Pacific Region
isbn: "978-0-660-37019-4"
address: |
  Pacific Biological Station\
  Fisheries and Oceans Canada, 3190 Hammond Bay Road\
  Nanaimo, British Columbia, V9T 6N7, Canada\
phone: "(250) 756-7067"
author_footnote: "Email: Erika.Anderson@dfo-mpo.gc.ca | telephone: (250) 756-7067"
abstract: |
  Here is the abstract text. 
  
abstract_other: |
  Voici le résumé. 
  
output:
 csasdown::techreport_word:
   french: false
   copy_sty: false
   line_nums: true
   line_nums_mod: 1
type:
  techreport
# ------------
# End of options to set
knit: bookdown::render_book
site: bookdown::bookdown_site
link-citations: true
bibliography: bib/refs.bib
csl: csl/csas.csl
lot: true
lof: true
# Any extra LaTeX code for the header:
header-includes:
 - \usepackage{float}
---

```{r setup, echo=FALSE, cache=FALSE, message=FALSE, results='hide', warning=FALSE}
library(knitr)
if (is_latex_output()) {
  knitr_figs_dir <- "knitr-figs-pdf/"
  knitr_cache_dir <- "knitr-cache-pdf/"
  fig_out_type <- "png"
} else {
  knitr_figs_dir <- "knitr-figs-docx/"
  knitr_cache_dir <- "knitr-cache-docx/"
  fig_out_type <- "png"
}
fig_asp <- 0.618
fig_width <- 9
fig_out_width <- "6in"
fig_dpi <- 180
fig_align <- "center"
fig_pos <- "htb"
opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  comment = "#>",
  fig.path = knitr_figs_dir,
  cache.path = knitr_cache_dir,
  fig.asp = fig_asp,
  fig.width = fig_width,
  out.width = fig_out_width,
  echo = FALSE,
  #  autodep = TRUE,
  cache = FALSE,
  cache.comments = FALSE,
  dev = fig_out_type,
  dpi = fig_dpi,
  fig.align = fig_align,
  fig.pos = fig_pos
)
options(xtable.comment = FALSE)
options(kableExtra.latex.load_packages = FALSE)

# EA added the options below

# hide NAs within tables
  options(knitr.kable.NA = '')

# turn off significant figures
  options(scipen = 999)
  
```

```{r load-libraries, cache=FALSE}
# `french` and `prepub` variables are extracted from the YAML headers above and
#  are used throughout the document. To make the document all in french, change
#  the line in the YAML header above to `french: true`
meta <- rmarkdown::metadata$output
if (length(grep("pdf", names(meta)))) {
  french <- meta$`csasdown::techreport_pdf`$french
  prepub <- meta$`csasdown::techreport_pdf`$prepub
} else if (length(grep("word", names(meta)))) {
  french <- meta$`csasdown::techreport_word`$french
  prepub <- meta$`csasdown::techreport_word`$prepub
}

# add other packages here:
library(tidyverse)
library(csasdown)
library(car) # statistics
library(RODBC) # database connection
library(lubridate) # functions with dates
library(cowplot) # multiple plots in one
library(float) # fix the table-page breaks
library(broom) # display linear model on LW graphs easily
library(xfun) # to convert numeric values to text
library(measurements) #to convert lat/lon values
library(openxlsx) # load excel data
library(rgdal) # to load shapefiles
library(naniar) # function replace_with_na
library(kableExtra) # better table layouts
library(geosphere) # distance between lat and long
library(fossil) # calculate heading

```

```{r surveyDetails}

# *** survey number 
# note the extra quotes are needed
CRUISEchr <- "'2019125'"
CRUISEnum <- 2019125

surveyName <- "ecosystem-based juvenile Pacific Salmon survey"

surveyDateRange <- "September 30 to October 8, 2019"

surveyYear <- "2019"

vessel <- "CFV Sea Crest"

```

```{r locations}

# location data for maps from bridge data for fishing tows
# use sql 2019125_tows_orig: SELECT BRIDGE_COMPLETE.CRUISE, BRIDGE_COMPLETE.STATION_ID, BRIDGE_COMPLETE.EVENT, BRIDGE_COMPLETE.STATION, BRIDGE_COMPLETE.YEAR, BRIDGE_COMPLETE.MONTH, BRIDGE_COMPLETE.DAY, BRIDGE_COMPLETE.UNUSABLE, BRIDGE_COMPLETE.START_TIME, BRIDGE_COMPLETE.START_LAT, BRIDGE_COMPLETE.START_LONG, BRIDGE_COMPLETE.END_LAT, BRIDGE_COMPLETE.END_LONG, BRIDGE_COMPLETE.DISTANCE, BRIDGE_COMPLETE.DUR, BRIDGE_COMPLETE.[SOG-KTS], BRIDGE_COMPLETE.HEADING, BRIDGE_COMPLETE.START_BOT_DEPTH, BRIDGE_COMPLETE.END_BOT_DEPTH, BRIDGE_COMPLETE.NET_OPENING_WIDTH, BRIDGE_COMPLETE.NET_OPENING_HEIGHT, BRIDGE_COMPLETE.HEAD_DEPTH, BRIDGE_COMPLETE.WARP, BRIDGE_COMPLETE.GEAR FROM BRIDGE_COMPLETE WHERE (((BRIDGE_COMPLETE.CRUISE)="2019125"));

# load as csv
tows_orig <- readr::read_csv("data/csv/2019125_tows_orig.csv",
                             col_types = 
                               cols(
                               CRUISE = col_double(),
                               STATION_ID = col_character(),
                               EVENT = col_double(),
                               STATION = col_character(),
                               YEAR = col_double(),
                               MONTH = col_character(),
                               DAY = col_double(),
                               UNUSABLE = col_logical(),
                               START_TIME = col_character(),
                               START_LAT = col_double(),
                               START_LONG = col_double(),
                               END_LAT = col_double(),
                               END_LONG = col_double(),
                               DISTANCE = col_double(),
                               DUR = col_double(),
                               `SOG-KTS` = col_double(),
                               HEADING = col_double(),
                               START_BOT_DEPTH = col_double(),
                               END_BOT_DEPTH = col_double(),
                               NET_OPENING_WIDTH = col_double(),
                               NET_OPENING_HEIGHT = col_double(),
                               HEAD_DEPTH = col_double(),
                               WARP = col_double(),
                               GEAR = col_character()
                               ))

# location data for CTD casts from OCEAN_CTD table
# sql 2019125_ctd_orig
# SELECT BRIDGE_COMPLETE.CRUISE, OCEAN_CTD.STATION_ID, OCEAN_CTD.EVENT, OCEAN_CTD.STATION, OCEAN_CTD.CTD_INSTRUMENT, OCEAN_CTD.CTD_SERIAL_NUMBER, OCEAN_CTD.DATE_UTC, OCEAN_CTD.TIME_UTC, OCEAN_CTD.CTD_LAT, OCEAN_CTD.CTD_LONG, OCEAN_CTD.BOTTOM_DEPTH, OCEAN_CTD.CTD_DEPTH
# FROM OCEAN_CTD INNER JOIN BRIDGE_COMPLETE ON OCEAN_CTD.STATION_ID = BRIDGE_COMPLETE.STATION_ID
# WHERE (((BRIDGE_COMPLETE.CRUISE)="2019125"));

# # load as csv
ctd_orig <- readr::read_csv("data/csv/2019125_ctd_orig.csv")

# location data for vertical plankton tows from PLANKTON table
# sql
# # load as csv
plankton_orig <- readr::read_csv("data/csv/2019125_planton_orig.csv")




# wrangle data
tows <- tows_orig %>%
  mutate(DATE = ymd(str_c(YEAR, MONTH, DAY, sep = "-")),
         TARGET_DEPTH = as.factor(HEAD_DEPTH)) 

# find min and max lat and longs for limits to basemap
minLat <- min(tows$START_LAT) - 0.5
maxLat <- max(tows$START_LAT) + 0.5
minLon <- min(tows$START_LONG) - 0.5
maxLon <- max(tows$START_LONG) + 0.5

# load basemap from coastal shapefile
coast <- readOGR("data/Spatial/Land.shp", verbose = FALSE)

# basemap
  basemap <- ggplot() +
    geom_path(data = coast, aes(x = long, y = lat, group = group)) +
    coord_equal() +
    xlim(minLon, maxLon) +
    ylim(minLat, maxLat) +
    labs(x = "Longitude",
         y = "Laititude") +
    theme_bw()

```

